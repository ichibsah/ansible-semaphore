---

- name: 'Download and install Windows updates :)'
  hosts: pcs
  #connection: local
  #remote_user: adminqit
  #remote_user: adminqit
  #ansible_user: adminqit #ERROR! 'ansible_user' is not a valid attribute for a Play
  #become: true
  #gathering: smart #ERROR! 'gathering' is not a valid attribute for a Play
  gather_facts: True
  ignore_errors: True
  ignore_unreachable: true
  #become_method: runas 
  #become_user: adminqit
  

  vars:
    ansible_remote_user: adminqit #ERROR! 'ansible_remote_user' is not a valid attribute for a Play
    ansible_ssh_user: adminqit #ERROR! 'ansible_ssh_user' is not a valid attribute for a Play
    #ansible_shell_type: powershell #ERROR! 'ansible_shell_type' is not a valid attribute for a Play
    ansible_shell_type: cmd #ERROR! 'ansible_shell_type' is not a valid attribute for a Play
    #shell_type: powershell #ERROR! 'shell_type' is not a valid attribute for a Play
    #remote_tmp: C:\Tmp
    #ansible_remote_tmp: c\temp
    #remote_tmp: c\temp
    #ansible_ssh_password: adminqit
    #ansible_become_pass: '{{ jenkins_become_pass }}'
    #ansible_ssh_common_args: '-o StrictHostKeyChecking=no'


  tasks: 
  # Install/uninstall with chocolatey
  - name: Ensure 7-Zip is installed via Chocolatey
    win_chocolatey:
      name: 7zip
      state: present

  - name: Ensure 7-Zip is not installed via Chocolatey
    win_chocolatey:
      name: 7zip
      state: absent

  # Install/uninstall with win_package
  - name: Download the 7-Zip package
    win_get_url:
      url: https://www.7-zip.org/a/7z1701-x64.msi
      dest: C:\temp\7z.msi

  - name: Ensure 7-Zip is installed via win_package
    win_package:
      path: C:\temp\7z.msi
      state: present

  - name: Ensure 7-Zip is not installed via win_package
    win_package:
      path: C:\temp\7z.msi
      state: absent

  # Install/uninstall with win_command
  - name: Download the 7-Zip package
    win_get_url:
      url: https://www.7-zip.org/a/7z1701-x64.msi
      dest: C:\temp\7z.msi

  - name: Check if 7-Zip is already installed
    win_reg_stat:
      name: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\{23170F69-40C1-2702-1701-000001000000}
    register: 7zip_installed

  - name: Ensure 7-Zip is installed via win_command
    win_command: C:\Windows\System32\msiexec.exe /i C:\temp\7z.msi /qn /norestart
    when: 7zip_installed.exists == false

  - name: Ensure 7-Zip is uninstalled via win_command
    win_command: C:\Windows\System32\msiexec.exe /x {23170F69-40C1-2702-1701-000001000000} /qn /norestart
    when: 7zip_installed.exists == true